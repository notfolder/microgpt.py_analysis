# 16文字Pythonワンライナー生成システム

LM Studioを使用して、意味のある16文字以下のPythonワンライナーを30,000パターン生成するシステムです。

## 概要

- **目的**: Python REPLで実行可能な16文字以下のワンライナーを大量生成
- **手法**: LM Studio（ローカルLLM）を使用したFew-shot学習
- **検証**: 文字数、構文、実行可能性を自動検証
- **重複排除**: 完全一致 + Levenshtein距離による類似パターン検出

## システム構成

```
python_oneliner/
├── main.py              # メインプログラム
├── generator.py         # 生成モジュール（LM Studio API連携）
├── validator.py         # 検証モジュール（構文・実行検証）
├── deduplicator.py      # 重複排除モジュール
├── sample_pools.py      # サンプルプール定義
└── config.py            # 設定ファイル
```

## 事前準備

### 1. LM Studioのセットアップ

1. [LM Studio](https://lmstudio.ai/)をインストール
2. 適切なモデルをダウンロード（推奨: CodeLlama系、Mistral系）
3. LM Studioを起動し、Local Serverを開始
4. エンドポイント `http://localhost:1234` が利用可能であることを確認

### 2. Pythonパッケージのインストール

```bash
pip install requests
```

## 使用方法

### 基本実行

```bash
cd python_oneliner
python main.py
```

デフォルトでは以下の設定で実行されます：
- 出力ファイル: `python_oneliners_30k.txt`
- 目標: 30,000パターン
- カテゴリ: 6カテゴリ（数値計算、文字列操作、データ構造、組み込み関数、標準ライブラリ、その他・応用）

### テストモード

```bash
python main.py --test
```

各カテゴリ10パターンのみ生成し、動作確認を行います。

**改善されたフィードバック機能**

1. **カテゴリ開始時の進捗表示**
   - 各カテゴリ開始時に「カテゴリ X/Y」形式で進捗を表示
   - 全体の進行状況が把握しやすくなります

2. **カテゴリ完了時の即座推定**
   - 各カテゴリが完了したタイミングで、そのカテゴリの本番実行推定時間を即座に表示
   - 目標パターン数、1パターンあたりの時間、推定所要時間を表示
   - リアルタイムで各カテゴリの処理速度傾向を把握できます

3. **最終的な全体推定**
   - 全カテゴリ終了後に、全体の推定時間を詳細な表形式で表示
   - カテゴリ間の処理時間の違いを比較できます

**実行例：**

```
============================================================
カテゴリ: 数値計算 (1/6)
目標: 10パターン
============================================================
...
数値計算 完了: 10/10 パターン
所要時間: 0:01:30

📈 本番実行推定:
  - 目標パターン数: 5,000
  - 1パターンあたり: 9.00秒
  - 推定所要時間: 12:30:00 (12.50時間)

============================================================
カテゴリ: 文字列操作 (2/7)
目標: 10パターン
============================================================
...
```

これにより、各カテゴリの処理が終わるたびに推定値が更新され、待ち時間中も進捗が把握できます。

**全カテゴリ終了後の全体サマリー：**

全カテゴリ完了後には、全体の推定時間が表形式で表示されます：

```
============================================================
=== カテゴリ別 所要時間推定 ===
============================================================

カテゴリ     | テスト | 本番目標 |   所要時間 |   推定時間
----------------------------------------------------------------------
数値計算     |       10 |     5000 |     0:01:30 |     12:30:00
文字列操作   |       10 |     5000 |     0:01:25 |     11:52:00
...
----------------------------------------------------------------------

合計推定時間 |          |    25000 |            |     77:17:00

推定結果:
  - 25,000パターン生成予想時間: 77:17:00
  - 約 77.3 時間
```

### 出力ファイル指定

```bash
python main.py --output my_oneliners.txt
```

### 推奨ワークフロー

1. **まずテストモードで動作確認**
   ```bash
   python main.py --test
   ```
   推定時間を確認し、問題なければ本番実行へ

2. **本番実行**
   ```bash
   python main.py --output python_oneliners_30k.txt
   ```

## カテゴリ別生成配分

| カテゴリ | 目標数 | 内容 |
|---------|--------|------|
| 数値計算 | 6,000 | 算術演算、べき乗、ビット演算、複素数 |
| 文字列操作 | 6,000 | スライス、メソッド、結合、分割 |
| データ構造 | 6,000 | リスト、辞書、セット、タプル |
| 組み込み関数 | 6,000 | len, sum, max, min, sorted, map, filter等 |
| 標準ライブラリ | 4,000 | import文（os, sys, math, re, gc） |
| その他・応用 | 2,000 | 複数カテゴリの組み合わせ |
| **合計** | **30,000** | |

## 生成戦略

### Few-shot学習

各バッチで5個のサンプルを提示し、LLMに類似パターンを生成させます。

### バリエーション制御

1. **サンプルローテーション**: 過去3バッチのサンプルを除外
2. **温度パラメータ調整**: 生成数に応じて0.8→0.85→0.9に上昇
3. **ネガティブプロンプト**: 最近20パターンを「避けるべき例」として提示
4. **テンプレートローテーション**: 100バッチごとに表現を変更

### 3つの選択戦略（ローテーション）

- **均等分散**: 全サブカテゴリから均等に選択
- **重点分散**: 1つのサブカテゴリに重点を置く
- **ランダム分散**: 完全ランダムに選択

## 検証プロセス

1. **文字数検証**: 1-16文字の範囲内であることを確認
2. **構文検証**: `compile()`でシンタックスエラーがないことを確認
3. **実行検証**: サンドボックス環境で実際に実行可能であることを確認

## 重複排除

1. **完全一致検出**: set型によるO(1)の高速検索
2. **類似パターン検出**: Levenshtein距離（編集距離）< 3 で類似と判定
3. **最適化**: 文字数グループ化 + ハッシュプリフィルタで比較回数を削減

## 出力形式

- ファイル形式: プレーンテキスト
- エンコーディング: UTF-8
- フォーマット: 1行1ワンライナー
- 内容: 検証済みの重複なしパターンのみ

## 進捗表示

100パターン生成ごとに以下を表示：
- 生成数
- 検証通過数
- 重複除外数
- 経過時間

## 設定のカスタマイズ

`config.py`を編集することで以下をカスタマイズ可能：

- LM Studio APIエンドポイント
- バッチサイズ
- 温度パラメータ
- タイムアウト時間
- 重複判定閾値
- カテゴリ別目標数

## トラブルシューティング

### LM Studioに接続できない

- LM Studioが起動しているか確認
- Local Serverが開始されているか確認
- ポート1234が利用可能か確認

### 生成が遅い

- より高速なモデルを使用
- `config.py`の`BATCH_SIZE`を調整
- GPU搭載マシンを使用

### 検証エラーが多い

- より高性能なモデルを使用
- システムプロンプトを調整
- Few-shotサンプルを追加

## ライセンス

MIT License

## 参照

詳細な仕様は `../python_oneliner_spec.md` を参照してください。
